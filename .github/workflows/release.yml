name: 🚀 Build and Release

on:
    push:
        tags:
            - "v*" # Trigger on version tags like v1.0.0, v1.2.3, etc.

jobs:
    build-and-release:
        runs-on: windows-latest

        steps:
            - name: 📦 Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history for git info

            - name: 🔧 Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: 📋 Extract Version from Tag
              shell: bash
              run: |
                  # Extract version from git tag (remove 'v' prefix)
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "Tag version: $VERSION"

            - name: 🧪 Run Tests
              run: go test ./test/

            - name: 🔨 Build Jenvy Executable
              shell: bash
              run: |
                  # Build with embedded version info
                  BUILD_DATE=$(date -u +"%Y-%m-%d")
                  GIT_COMMIT=$(git rev-parse --short HEAD)

                  echo "Building jenvy.exe with version: $VERSION"
                  echo "Build date: $BUILD_DATE"
                  echo "Git commit: $GIT_COMMIT"

                  # Create build directory
                  mkdir -p build/dist

                  # Build with ldflags for version info
                  go build \
                    -ldflags "-X main.Version=$VERSION -X main.BuildDate=$BUILD_DATE -X main.GitCommit=$GIT_COMMIT" \
                    -o build/dist/jenvy.exe \
                    ./main.go

                  # Verify the build
                  ./build/dist/jenvy.exe --version

            - name: 📄 Convert README for Distribution
              shell: bash
              run: |
                  # Simple conversion - copy README.md as README.txt for installer
                  cp README.md build/dist/README.txt

            - name: 🏗️ Setup Inno Setup
              uses: crazy-max/ghaction-setup-innosetup@v3
              with:
                  version: "6.4.3"

            - name: ✅ Verify Inno Setup Installation
              shell: bash
              run: |
                  echo "🔍 Verifying Inno Setup installation..."
                  iscc_path=$(which iscc || echo "")
                  if [ -n "$iscc_path" ]; then
                      echo "✅ Inno Setup Compiler found at: $iscc_path"
                      iscc | head -5
                  else
                      echo "❌ Inno Setup Compiler not found in PATH"
                      echo "📁 Searching for ISCC.exe..."
                      find "/c/Program Files" -name "ISCC.exe" 2>/dev/null || echo "Not found in Program Files"
                      exit 1
                  fi

            - name: 📦 Build Installer
              shell: bash
              run: |
                  # Create release directory
                  mkdir -p release

                  # Update setup.iss with current version
                  echo "🔧 Updating setup.iss with version: $VERSION"
                  sed -i "s/#define MyAppVersion \".*\"/#define MyAppVersion \"$VERSION\"/" build/installer/setup.iss

                  # Verify version was updated
                  grep "MyAppVersion" build/installer/setup.iss

                  # Compile installer using iscc from PATH (more reliable)
                  echo "🔨 Compiling installer..."
                  cd build/installer
                  if command -v iscc >/dev/null 2>&1; then
                      iscc setup.iss
                  else
                      # Fallback to full path
                      "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" setup.iss
                  fi

                  # Verify installer was created
                  echo "✅ Installer build completed!"
                  ls -la ../../release/

            - name: ✅ Verify Build Artifacts
              shell: bash
              run: |
                  echo "📁 Build artifacts:"
                  echo "==================="
                  ls -lh build/dist/
                  echo ""
                  echo "📁 Release artifacts:"
                  echo "===================="
                  ls -lh release/
                  echo ""
                  echo "🔍 Jenvy executable info:"
                  echo "========================="
                  ./build/dist/jenvy.exe --version

            - name: 🏷️ Create GitHub Release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  name: "Jenvy v${{ env.VERSION }}"
                  body: |
                      ## 🎉 Jenvy v${{ env.VERSION }} - Developer Kit Manager

                      ### 📦 What's Included
                      - **jenvy-installer-${{ env.VERSION }}.exe** - Windows installer with automatic setup
                      - **jenvy.exe** - Standalone executable (portable)
                      - **README.txt** - Documentation and usage guide

                      ### 🚀 Quick Start
                      1. Download `jenvy-installer-${{ env.VERSION }}.exe`
                      2. Run the installer as Administrator
                      3. Open a new terminal and run: `jenvy remote-list`

                      ### ✨ Key Features
                      - 🌍 Multi-provider support (Adoptium, Azul Zulu, BellSoft Liberica)
                      - 🔒 Private enterprise repository integration
                      - 🎯 Smart version selection with LTS priority
                      - 🔧 Automatic JAVA_HOME and PATH management
                      - 💻 Shell completions (Bash, PowerShell, CMD)
                      - 📊 Professional CLI with formatted tables

                      ### 📋 System Requirements
                      - Windows 10/11 (64-bit)
                      - Administrator privileges for installation
                      - Internet connection for JDK downloads

                      ### 💖 Support the Project
                      - ⭐ Star this repository
                      - 💰 GitHub Sponsors: [@MarcoAntonioRussoDEV](https://github.com/sponsors/MarcoAntonioRussoDEV)
                      - ☕ Ko-fi: [marcoantoniomosca](https://ko-fi.com/marcoantoniomosca)
                      - 💳 PayPal: [Donate](https://paypal.me/marcorusso94)

                      ### 🔗 Links
                      - 📚 [Full Documentation](https://github.com/MarcoAntonioRussoDEV/Jenvy#readme)
                      - 🐛 [Report Issues](https://github.com/MarcoAntonioRussoDEV/Jenvy/issues)
                      - 💬 [Discussions](https://github.com/MarcoAntonioRussoDEV/Jenvy/discussions)
                  draft: false
                  prerelease: false
                  files: |
                      release/jenvy-installer-${{ env.VERSION }}.exe
                      build/dist/jenvy.exe
                      build/dist/README.txt

            - name: 🎊 Release Summary
              shell: bash
              run: |
                  echo "🎉 Successfully created release v$VERSION!"
                  echo "📥 Download URL: https://github.com/MarcoAntonioRussoDEV/Jenvy/releases/tag/v$VERSION"
                  echo "📦 Installer: jenvy-installer-$VERSION.exe"
                  echo "🚀 Jenvy is ready for distribution!"
