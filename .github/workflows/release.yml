name: ğŸš€ Build and Release

on:
    push:
        tags:
            - "v*" # Trigger on version tags like v1.0.0, v1.2.3, etc.

jobs:
    build-and-release:
        runs-on: windows-latest

        steps:
            - name: ğŸ“¦ Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history for git info

            - name: ğŸ”§ Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.21"

            - name: ğŸ“‹ Extract Version from Tag
              shell: bash
              run: |
                  # Extract version from git tag (remove 'v' prefix)
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "Tag version: $VERSION"

            - name: ğŸ§ª Run Tests
              run: go test ./test/

            - name: ğŸ”¨ Build Jenvy Executable
              shell: bash
              run: |
                  # Build with embedded version info
                  BUILD_DATE=$(date -u +"%Y-%m-%d")
                  GIT_COMMIT=$(git rev-parse --short HEAD)

                  echo "Building jenvy.exe with version: $VERSION"
                  echo "Build date: $BUILD_DATE"
                  echo "Git commit: $GIT_COMMIT"

                  # Create build directory
                  mkdir -p build/dist

                  # Build with ldflags for version info
                  go build \
                    -ldflags "-X main.Version=$VERSION -X main.BuildDate=$BUILD_DATE -X main.GitCommit=$GIT_COMMIT" \
                    -o build/dist/jenvy.exe \
                    ./main.go

                  # Verify the build
                  ./build/dist/jenvy.exe --version

            - name: ğŸ“„ Convert README for Distribution
              shell: bash
              run: |
                  # Simple conversion - copy README.md as README.txt for installer
                  cp README.md build/dist/README.txt

            - name: ğŸ—ï¸ Setup Inno Setup
              uses: crazy-max/ghaction-setup-innosetup@v3
              with:
                  version: "6.4.3"

            - name: âœ… Verify Inno Setup Installation
              shell: bash
              run: |
                  echo "ğŸ” Verifying Inno Setup installation..."
                  iscc_path=$(which iscc || echo "")
                  if [ -n "$iscc_path" ]; then
                      echo "âœ… Inno Setup Compiler found at: $iscc_path"
                      iscc | head -5
                  else
                      echo "âŒ Inno Setup Compiler not found in PATH"
                      echo "ğŸ“ Searching for ISCC.exe..."
                      find "/c/Program Files" -name "ISCC.exe" 2>/dev/null || echo "Not found in Program Files"
                      exit 1
                  fi

            - name: ğŸ“¦ Build Installer
              shell: bash
              run: |
                  # Create release directory
                  mkdir -p release

                  # Update setup.iss with current version
                  echo "ğŸ”§ Updating setup.iss with version: $VERSION"
                  sed -i "s/#define MyAppVersion \".*\"/#define MyAppVersion \"$VERSION\"/" build/installer/setup.iss

                  # Verify version was updated
                  grep "MyAppVersion" build/installer/setup.iss

                  # Compile installer using iscc from PATH (more reliable)
                  echo "ğŸ”¨ Compiling installer..."
                  cd build/installer
                  if command -v iscc >/dev/null 2>&1; then
                      iscc setup.iss
                  else
                      # Fallback to full path
                      "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" setup.iss
                  fi

                  # Verify installer was created
                  echo "âœ… Installer build completed!"
                  ls -la ../../release/

            - name: âœ… Verify Build Artifacts
              shell: bash
              run: |
                  echo "ğŸ“ Build artifacts:"
                  echo "==================="
                  ls -lh build/dist/
                  echo ""
                  echo "ğŸ“ Release artifacts:"
                  echo "===================="
                  ls -lh release/
                  echo ""
                  echo "ğŸ” Jenvy executable info:"
                  echo "========================="
                  ./build/dist/jenvy.exe --version

            - name: ğŸ·ï¸ Create GitHub Release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  name: "Jenvy v${{ env.VERSION }}"
                  body: |
                      ## ğŸ‰ Jenvy v${{ env.VERSION }} - Developer Kit Manager

                      ### ğŸ“¦ What's Included
                      - **jenvy-installer-${{ env.VERSION }}.exe** - Windows installer with automatic setup
                      - **jenvy.exe** - Standalone executable (portable)
                      - **README.txt** - Documentation and usage guide

                      ### ğŸš€ Quick Start
                      1. Download `jenvy-installer-${{ env.VERSION }}.exe`
                      2. Run the installer as Administrator
                      3. Open a new terminal and run: `jenvy remote-list`

                      ### âœ¨ Key Features
                      - ğŸŒ Multi-provider support (Adoptium, Azul Zulu, BellSoft Liberica)
                      - ğŸ”’ Private enterprise repository integration
                      - ğŸ¯ Smart version selection with LTS priority
                      - ğŸ”§ Automatic JAVA_HOME and PATH management
                      - ğŸ’» Shell completions (Bash, PowerShell, CMD)
                      - ğŸ“Š Professional CLI with formatted tables

                      ### ğŸ“‹ System Requirements
                      - Windows 10/11 (64-bit)
                      - Administrator privileges for installation
                      - Internet connection for JDK downloads

                      ### ğŸ’– Support the Project
                      - â­ Star this repository
                      - ğŸ’° GitHub Sponsors: [@MarcoAntonioRussoDEV](https://github.com/sponsors/MarcoAntonioRussoDEV)
                      - â˜• Ko-fi: [marcoantoniomosca](https://ko-fi.com/marcoantoniomosca)
                      - ğŸ’³ PayPal: [Donate](https://paypal.me/marcorusso94)

                      ### ğŸ”— Links
                      - ğŸ“š [Full Documentation](https://github.com/MarcoAntonioRussoDEV/Jenvy#readme)
                      - ğŸ› [Report Issues](https://github.com/MarcoAntonioRussoDEV/Jenvy/issues)
                      - ğŸ’¬ [Discussions](https://github.com/MarcoAntonioRussoDEV/Jenvy/discussions)
                  draft: false
                  prerelease: false
                  files: |
                      release/jenvy-installer-${{ env.VERSION }}.exe
                      build/dist/jenvy.exe
                      build/dist/README.txt

            - name: ğŸŠ Release Summary
              shell: bash
              run: |
                  echo "ğŸ‰ Successfully created release v$VERSION!"
                  echo "ğŸ“¥ Download URL: https://github.com/MarcoAntonioRussoDEV/Jenvy/releases/tag/v$VERSION"
                  echo "ğŸ“¦ Installer: jenvy-installer-$VERSION.exe"
                  echo "ğŸš€ Jenvy is ready for distribution!"
